# üöÄ D√©ploiement d'une Application Node.js sur Google Cloud Platform (GCP)

> **Guide Complet pour D√©butants - De Z√©ro √† Production sur GCP**
>
> Par **samba-diallo** | Octobre 2025

[![GCP](https://img.shields.io/badge/Google_Cloud-Compute_Engine-blue?style=flat&logo=google-cloud)](https://cloud.google.com/)
[![Node.js](https://img.shields.io/badge/Node.js-21.x-green?style=flat&logo=node.js)](https://nodejs.org/)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![DevOps](https://img.shields.io/badge/DevOps-Basics-blueviolet)](https://cloud.google.com/)

---

## üìë Table des Mati√®res

- [Introduction](#-introduction)
- [Pr√©requis](#-pr√©requis)
- [Partie 1 : Configuration GCP](#-partie-1--configuration-gcp)
- [Partie 2 : D√©ploiement Compute Engine](#-partie-2--d√©ploiement-compute-engine)
- [Partie 3 : Comprendre le Code](#-partie-3--comprendre-le-code)
- [Partie 4 : Test & V√©rification](#-partie-4--test--v√©rification)
- [Exercices Pratiques](#-exercices-pratiques)
- [D√©pannage](#-d√©pannage)
- [Nettoyage](#-nettoyage)
- [GCP vs AWS : Comparaison](#-gcp-vs-aws--comparaison)
- [Conclusion](#-conclusion)
- [Ressources](#-ressources)

---

## üéØ Introduction

### Qu'allez-vous Apprendre ?

Ce guide vous apprend √† d√©ployer une application web simple sur **Google Cloud Platform (GCP)** en utilisant **Compute Engine** (√©quivalent d'EC2 sur AWS). Vous d√©couvrirez l'√©cosyst√®me Google Cloud et comparerez avec AWS.

### üéì Comp√©tences Acquises

- ‚úÖ Cr√©er et configurer un compte Google Cloud
- ‚úÖ G√©rer les identit√©s avec IAM (Identity and Access Management)
- ‚úÖ Lancer une VM (Virtual Machine) sur Compute Engine
- ‚úÖ Configurer des r√®gles de pare-feu (Firewall Rules)
- ‚úÖ Automatiser avec Startup Scripts
- ‚úÖ D√©ployer une application Node.js sur GCP
- ‚úÖ Comparer GCP et AWS

### üíº Pourquoi Google Cloud Platform ?

```
üåê GCP dans le Monde
   ‚Üí #3 mondial du cloud (10% de parts de march√©)
   ‚Üí Utilis√© par : Spotify, Twitter, Snapchat, PayPal
   ‚Üí Infrastructure de Google (Gmail, YouTube, Search)

üí° Avantages Uniques de GCP
   ‚Üí R√©seau priv√© global le plus rapide
   ‚Üí Pricing transparent et pr√©visible
   ‚Üí Live migration (maintenance sans downtime)
   ‚Üí BigQuery (analytics √† l'√©chelle mondiale)
   ‚Üí Kubernetes natif (GKE - Google Kubernetes Engine)

üí∞ Opportunit√©s Carri√®re
   ‚Üí Cloud Engineer (GCP) : 65-110k‚Ç¨/an
   ‚Üí Data Engineer (GCP) : 70-120k‚Ç¨/an
   ‚Üí Comp√©tence compl√©mentaire √† AWS

üîÑ Comparaison avec AWS
   ‚Üí GCP : Simplicit√©, innovation, data analytics
   ‚Üí AWS : Maturit√©, breadth de services, market leader
   ‚Üí Multi-cloud = Valeur ajout√©e sur le march√©
```

---

## üìã Pr√©requis

### Connaissances

| Niveau | Requis |
|--------|--------|
| **Essentiel** | Utilisation d'un navigateur web |
| **Recommand√©** | Notions de ligne de commande (bash/shell) |
| **Utile** | Bases de JavaScript/Node.js |
| **Bonus** | Connaissance d'AWS (pour comparaison) |

### Outils N√©cessaires

| Outil | Utilit√© | T√©l√©chargement |
|-------|---------|----------------|
| **Navigateur Web** | Acc√®s GCP Console | Chrome (recommand√©), Firefox |
| **Compte Google** | Authentification | [Gmail](https://gmail.com) |
| **Carte Bancaire** | V√©rification (300$ gratuits) | - |

### üí∞ Co√ªts GCP

```
‚úÖ GCP Free Tier (Toujours gratuit)
   ‚Üí e2-micro VM : 1 instance/mois GRATUIT (US regions)
   ‚Üí 30 GB stockage persistant
   ‚Üí 5 GB snapshots
   ‚Üí 1 GB r√©seau sortant/mois

üéÅ GCP Free Trial (Nouvel utilisateur)
   ‚Üí 300 USD de cr√©dits GRATUITS
   ‚Üí Valable 90 jours
   ‚Üí Aucune facturation automatique apr√®s expiration
   ‚Üí Carte bancaire requise (v√©rification, pas de d√©bit)

üí° Pour ce Tutoriel
   ‚Üí Co√ªt : 0‚Ç¨ (avec Free Trial)
   ‚Üí VM e2-micro (Always Free Tier)
   ‚Üí Dur√©e : ~2-3 heures de test
   ‚Üí N'oubliez pas de supprimer apr√®s !

‚ö†Ô∏è Important
   ‚Üí Utilisez e2-micro (Always Free)
   ‚Üí R√©gion : us-central1, us-west1, ou us-east1
   ‚Üí Supprimez les ressources apr√®s test
```

---

## üîê Partie 1 : Configuration GCP

### √âtape 1.1 : Cr√©er un Compte Google Cloud

#### üîó Inscription

**1. Acc√©der √† GCP**

```
https://cloud.google.com
```

**2. Cliquer sur "Get started for free" (Commencer gratuitement)**

**3. Se Connecter avec Compte Google**

```
Utilisez un compte Gmail existant
OU
Cr√©ez un nouveau compte Google
```

**4. Accepter les Conditions d'Utilisation**

```
‚òëÔ∏è Terms of Service
‚òëÔ∏è Email updates (optionnel)
```

**5. Informations de Compte**

| Information | Exemple | Requis |
|-------------|---------|--------|
| **Pays** | France | ‚úÖ |
| **Type de compte** | Individual (Particulier) | ‚úÖ |
| **Carte bancaire** | VISA/MasterCard | ‚úÖ (v√©rification) |

**6. V√©rification de la Carte**

```
Pr√©l√®vement : 0‚Ç¨ ou ~1‚Ç¨ (rembours√© imm√©diatement)
But : V√©rification que vous n'√™tes pas un robot
‚ö†Ô∏è Aucune facturation automatique apr√®s Free Trial
```

**7. Confirmation**

```
‚úÖ 300 USD de cr√©dits ajout√©s
‚úÖ Valables 90 jours
‚úÖ Compte GCP cr√©√© !
```

---

#### üé® Interface GCP Console

**Acc√©der √† la Console :**

```
https://console.cloud.google.com
```

**√âl√©ments Cl√©s :**

| √âl√©ment | Description | Emplacement |
|---------|-------------|-------------|
| **Navigation Menu** | ‚ò∞ Tous les services GCP | Haut gauche |
| **Project Selector** | Choisir/cr√©er un projet | Haut (nom du projet) |
| **Search Bar** | Rechercher services/ressources | Haut centre |
| **Cloud Shell** | Terminal dans le navigateur | Ic√¥ne `>_` en haut |
| **Notifications** | Alertes et logs | Ic√¥ne cloche |

---

### √âtape 1.2 : Cr√©er un Projet GCP

#### üéØ Qu'est-ce qu'un Projet GCP ?

```
Projet GCP = Conteneur logique pour vos ressources

Caract√©ristiques :
‚Üí Isole les ressources (VMs, databases, etc.)
‚Üí Facturation s√©par√©e
‚Üí Permissions granulaires (IAM)
‚Üí Quotas et limites ind√©pendants

Analogie :
‚Üí Projet = Dossier pour organiser vos fichiers
‚Üí Ressources = Fichiers dans le dossier

Bonnes Pratiques :
‚Üí 1 projet par environnement (dev, staging, prod)
‚Üí 1 projet par application
‚Üí Nommage coh√©rent (ex : mon-app-dev)
```

---

#### üìù Cr√©ation du Projet

**M√©thode 1 : Via l'Interface**

```
1. Cliquer sur le s√©lecteur de projet (haut de la page)
2. Cliquer sur "NEW PROJECT" (Nouveau projet)
3. Remplir les informations
```

**Configuration :**

| Champ | Valeur | Exemple |
|-------|--------|---------|
| **Project name** | Nom descriptif | `sample-app-project` |
| **Project ID** | Identifiant unique (g√©n√©r√© auto) | `sample-app-project-438201` |
| **Organization** | Laisser vide (pas d'organisation) | - |
| **Location** | No organization | - |

**4. Cliquer sur "CREATE"**

**5. Confirmation**

```
‚úÖ Projet cr√©√© !
üîÑ Basculer vers le nouveau projet (s√©lecteur en haut)
```

---

**M√©thode 2 : Via Cloud Shell (Avanc√©)**

```bash
# Ouvrir Cloud Shell (ic√¥ne >_ en haut)

# Cr√©er un projet
gcloud projects create sample-app-project-$RANDOM \
    --name="Sample App Project"

# D√©finir comme projet par d√©faut
gcloud config set project sample-app-project-XXXXX

# V√©rifier
gcloud config get-value project
```

---

#### ‚öôÔ∏è Activer les APIs N√©cessaires

**GCP n√©cessite d'activer les APIs avant utilisation**

**APIs √† Activer :**

```
1. Compute Engine API
2. Cloud Resource Manager API (d√©j√† activ√©e)
```

**Activation via Interface :**

```
1. Navigation Menu (‚ò∞)
2. APIs & Services ‚Üí Library
3. Rechercher : "Compute Engine API"
4. Cliquer dessus
5. Bouton "ENABLE" (Activer)
6. Attendre ~30 secondes
```

**Activation via Cloud Shell :**

```bash
# Activer Compute Engine API
gcloud services enable compute.googleapis.com

# V√©rifier les APIs activ√©es
gcloud services list --enabled
```

---

### √âtape 1.3 : Configuration IAM (Identity and Access Management)

#### üéØ Comprendre IAM sur GCP

**IAM = Who can do What on Which resource**

```
Concepts Cl√©s :

1. Members (Qui)
   ‚Üí Google Account (user@gmail.com)
   ‚Üí Service Account (app@project.iam.gserviceaccount.com)
   ‚Üí Google Group
   ‚Üí Cloud Identity domain

2. Roles (Quoi)
   ‚Üí Primitive : Owner, Editor, Viewer
   ‚Üí Predefined : roles/compute.admin
   ‚Üí Custom : Cr√©√©s par vous

3. Resources (Sur quoi)
   ‚Üí Project
   ‚Üí VM instance
   ‚Üí Storage bucket
   ‚Üí Etc.

Mod√®le :
Member + Role ‚Üí Access to Resource
```

---

#### üîê Cr√©er un Compte de Service (Service Account)

**Qu'est-ce qu'un Service Account ?**

```
Service Account = Identit√© pour applications/VMs

Diff√©rence User vs Service Account :

User Account :
‚Üí Pour humains (vous)
‚Üí Connexion via Google login
‚Üí MFA, r√©cup√©ration de compte

Service Account :
‚Üí Pour applications/scripts
‚Üí Authentification via cl√©s
‚Üí Pas d'interface utilisateur

Usage :
‚Üí VM qui acc√®de √† Cloud Storage
‚Üí Application qui √©crit dans BigQuery
‚Üí Script qui cr√©e des ressources
```

---

**Cr√©ation :**

**Via Interface :**

```
1. Navigation Menu (‚ò∞)
2. IAM & Admin ‚Üí Service Accounts
3. "+ CREATE SERVICE ACCOUNT"
4. Configuration :
```

| Champ | Valeur |
|-------|--------|
| **Service account name** | `sample-app-sa` |
| **Service account ID** | `sample-app-sa` (auto-g√©n√©r√©) |
| **Description** | `Service account for sample app` |

```
5. CONTINUE
6. Grant this service account access to project :
   Role : Compute Admin (roles/compute.admin)
7. CONTINUE
8. DONE
```

**Via Cloud Shell :**

```bash
# Cr√©er service account
gcloud iam service-accounts create sample-app-sa \
    --display-name="Sample App Service Account"

# Ajouter le r√¥le
PROJECT_ID=$(gcloud config get-value project)
gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member="serviceAccount:sample-app-sa@$PROJECT_ID.iam.gserviceaccount.com" \
    --role="roles/compute.admin"
```

---

#### üõ°Ô∏è Activer l'Authentification √† Deux Facteurs (2FA)

**Pour votre Compte Google :**

```
1. Aller sur : https://myaccount.google.com/security
2. Section "Signing in to Google"
3. Cliquer sur "2-Step Verification"
4. Suivre les instructions :
   - Num√©ro de t√©l√©phone (SMS)
   OU
   - Google Authenticator (recommand√©)
5. Activer
```

**Pourquoi c'est CRITIQUE :**

```
Statistiques S√©curit√© :
‚Üí 2FA bloque 100% des bots automatis√©s (Google)
‚Üí 99% des attaques de phishing (Microsoft)
‚Üí Protection compte Google = Protection GCP

‚ö†Ô∏è Sans 2FA :
‚ùå Compte Google compromis = Acc√®s GCP
‚ùå Peut g√©n√©rer des milliers d'euros de factures
‚ùå Peut supprimer toutes vos donn√©es

‚úÖ Avec 2FA :
‚úÖ Protection maximale
‚úÖ Standard entreprise
‚úÖ Obligation pour comptes critiques
```

---

### √âtape 1.4 : Configuration de la Facturation

#### üí≥ Comprendre la Facturation GCP

**Mod√®le de Facturation :**

```
GCP Billing = Pay-as-you-go

Concepts :
‚Üí Billing Account (Compte de facturation)
‚Üí Projects li√©s au compte
‚Üí Budgets et alertes
‚Üí Free Tier toujours actif

Transparence :
‚Üí Pricing Calculator
‚Üí Facturation √† la seconde (vs minute sur AWS)
‚Üí Sustained Use Discounts (r√©ductions automatiques)
‚Üí Committed Use Discounts (contrats long terme)
```

---

**V√©rifier le Compte de Facturation :**

```
1. Navigation Menu (‚ò∞)
2. Billing
3. Vous devriez voir :
   - My Billing Account
   - Free trial status : $300 remaining
   - Days remaining : ~90
```

**Configurer un Budget (Recommand√©) :**

```
1. Billing ‚Üí Budgets & alerts
2. CREATE BUDGET
3. Configuration :
```

| Param√®tre | Valeur |
|-----------|--------|
| **Name** | `Sample App Budget` |
| **Projects** | S√©lectionner votre projet |
| **Budget amount** | `10 USD` |
| **Alert threshold** | `50%, 90%, 100%` |
| **Email notifications** | Votre email |

```
4. FINISH
```

**R√©sultat :**

```
‚úÖ Email si d√©penses > 5 USD (50%)
‚úÖ Email si d√©penses > 9 USD (90%)
‚úÖ Email si d√©penses > 10 USD (100%)
‚ö†Ô∏è Budget = Alerte seulement (pas de coupure automatique)
```

---

## üñ•Ô∏è Partie 2 : D√©ploiement Compute Engine

### Qu'est-ce que Compute Engine ?

**Compute Engine = Service de VMs (Virtual Machines) de GCP**

```
D√©finition :
‚Üí √âquivalent d'EC2 sur AWS
‚Üí Serveurs virtuels √† la demande
‚Üí Infrastructure Google mondiale

Avantages :
‚úÖ D√©marrage ultra-rapide (~20 secondes)
‚úÖ Live migration (maintenance sans interruption)
‚úÖ R√©seau priv√© Google (latence minimale)
‚úÖ Disques persistants haute performance
‚úÖ Snapshots et backups automatiques

Cas d'usage :
‚Üí H√©berger applications web
‚Üí Serveurs de base de donn√©es
‚Üí Calcul haute performance
‚Üí Containers (avant Kubernetes)
‚Üí CI/CD runners
```

---

### √âtape 2.1 : Lancer une Instance VM

#### üöÄ Acc√©der √† Compute Engine

**Via Interface :**

```
1. Navigation Menu (‚ò∞)
2. Compute Engine ‚Üí VM instances
3. Si premi√®re utilisation :
   - Attendre initialisation (~1 minute)
   - API Compute Engine s'active
4. Cliquer "CREATE INSTANCE"
```

---

#### üìù Configuration de l'Instance

**1Ô∏è‚É£ Nom et R√©gion**

| Param√®tre | Valeur | Explication |
|-----------|--------|-------------|
| **Name** | `sample-app-vm` | Identifiant de la VM |
| **Labels** | `env=dev`, `app=sample` | Organisation (optionnel) |
| **Region** | `us-central1` | Iowa, USA (Free Tier) |
| **Zone** | `us-central1-a` | Zone de disponibilit√© |

**Pourquoi us-central1 ?**

```
Free Tier (Always Free) :
‚Üí us-west1 (Oregon)
‚Üí us-central1 (Iowa)
‚Üí us-east1 (South Carolina)

Autres r√©gions = Facturation normale

Pour ce tutoriel :
‚úÖ Choisir us-central1 (Free Tier)
‚ùå europe-west1 (Belgique) = Co√ªt
```

---

**2Ô∏è‚É£ Machine Configuration (Type de VM)**

**GCP propose plusieurs familles de machines :**

| Famille | Usage | Exemple |
|---------|-------|---------|
| **E2** | Usage g√©n√©ral, √©conomique | e2-micro, e2-small |
| **N2** | Balanced, haute performance | n2-standard-2 |
| **C2** | Compute-optimized | c2-standard-4 |
| **M2** | Memory-optimized | m2-ultramem-208 |

**Configuration pour ce Tutoriel :**

```
‚òëÔ∏è Machine family : General-purpose
‚òëÔ∏è Series : E2
‚òëÔ∏è Machine type : e2-micro

Specs :
- 2 vCPUs (shared-core)
- 1 GB RAM
- ‚úÖ FREE TIER (Always Free)

Co√ªt (si hors Free Tier) :
- ~$6.11/mois (730 heures)
- ~$0.008365/heure
```

**Comparaison Types de Machines :**

| Type | vCPU | RAM | Co√ªt/mois | Free Tier |
|------|------|-----|-----------|-----------|
| **e2-micro** | 2 | 1 GB | $6.11 | ‚úÖ |
| e2-small | 2 | 2 GB | $12.22 | ‚ùå |
| e2-medium | 2 | 4 GB | $24.44 | ‚ùå |
| e2-standard-2 | 2 | 8 GB | $48.88 | ‚ùå |

---

**3Ô∏è‚É£ Boot Disk (Disque de D√©marrage)**

**Cliquer sur "CHANGE" (Modifier)**

| Param√®tre | Valeur |
|-----------|--------|
| **Operating System** | Ubuntu |
| **Version** | Ubuntu 22.04 LTS (Jammy Jellyfish) |
| **Boot disk type** | Standard persistent disk |
| **Size** | 10 GB |

**Pourquoi Ubuntu ?**

```
Ubuntu 22.04 LTS :
‚úÖ Long Term Support (5 ans de mises √† jour)
‚úÖ Large communaut√©
‚úÖ APT package manager (familier)
‚úÖ Compatible avec la plupart des tutos
‚úÖ Support Docker natif

Alternatives :
- Debian 11 (plus l√©ger)
- CentOS Stream (Red Hat ecosystem)
- Container-Optimized OS (pour containers)
```

**Cliquer "SELECT" (S√©lectionner)**

---

**4Ô∏è‚É£ Firewall (Pare-feu)** üî• CRITIQUE

**Dans la section "Firewall" :**

```
‚òëÔ∏è Allow HTTP traffic
‚òê Allow HTTPS traffic (pas n√©cessaire pour ce tuto)
```

**‚ö†Ô∏è IMPORTANT :**

```
Cocher "Allow HTTP traffic" :
‚Üí Cr√©e automatiquement une r√®gle de firewall
‚Üí Autorise le port 80 (HTTP)
‚Üí Source : 0.0.0.0/0 (tout Internet)

Sans cette option :
‚ùå Firewall bloque tout le trafic HTTP
‚ùå Erreur "Connection timeout"
‚ùå Application inaccessible
```

---

**5Ô∏è‚É£ Management, Security, Disks, Networking, Sole Tenancy**

**Cliquer sur "Management" pour d√©velopper**

**Naviguer vers "Automation" (en bas de Management)**

**Section "Startup script" :**

C'est ici que nous allons coller notre script d'installation !

---

### √âtape 2.2 : Le Startup Script

#### üéØ Qu'est-ce qu'un Startup Script ?

```
Startup Script = Script ex√©cut√© au d√©marrage de la VM

√âquivalent :
‚Üí AWS : User Data
‚Üí GCP : Startup Script / Metadata

Caract√©ristiques :
‚úÖ Ex√©cut√© automatiquement par GCP
‚úÖ √Ä chaque d√©marrage (diff√©rence avec AWS !)
‚úÖ Privil√®ges root
‚úÖ Permet automation

Diff√©rence AWS vs GCP :
AWS User Data ‚Üí 1 seule fois (premier boot)
GCP Startup Script ‚Üí √Ä chaque boot (par d√©faut)

Configuration :
‚Üí Stock√© dans instance metadata
‚Üí Peut √™tre mis √† jour sans recr√©er la VM
```

---

#### üìù Le Script Complet

**Copier-coller dans "Startup script" :**

```bash
#!/bin/bash
set -e

# Log everything
exec > >(tee /var/log/startup-script.log)
exec 2>&1

echo "=========================================="
echo "Starting Startup Script"
echo "Time: $(date)"
echo "=========================================="

# Update system
echo "Updating system packages..."
apt-get update
apt-get upgrade -y

# Install Node.js 21.x
echo "Installing Node.js..."
curl -fsSL https://deb.nodesource.com/setup_21.x | bash -
apt-get install -y nodejs

# Verify installation
echo "Node.js version: $(node --version)"
echo "npm version: $(npm --version)"

# Create application directory
echo "Creating application directory..."
mkdir -p /opt/sample-app
cd /opt/sample-app

# Create app.js
echo "Creating app.js..."
cat > /opt/sample-app/app.js << 'EOF'
const http = require('http');
const os = require('os');

const server = http.createServer((req, res) => {
  const hostname = os.hostname();
  const platform = os.platform();
  const uptime = process.uptime();
  
  res.writeHead(200, { 'Content-Type': 'text/html' });
  res.end(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Hello from GCP!</title>
      <style>
        body {
          font-family: Arial, sans-serif;
          max-width: 800px;
          margin: 50px auto;
          padding: 20px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
        }
        .container {
          background: rgba(255,255,255,0.1);
          padding: 30px;
          border-radius: 10px;
          backdrop-filter: blur(10px);
        }
        h1 { margin-top: 0; }
        .info { margin: 10px 0; }
        code {
          background: rgba(0,0,0,0.3);
          padding: 2px 6px;
          border-radius: 3px;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>üéâ Hello from Google Cloud Platform!</h1>
        <p class="info">‚úÖ Your Node.js app is running successfully on GCP Compute Engine</p>
        <hr>
        <p class="info"><strong>Hostname:</strong> <code>${hostname}</code></p>
        <p class="info"><strong>Platform:</strong> <code>${platform}</code></p>
        <p class="info"><strong>App Uptime:</strong> <code>${uptime.toFixed(2)}s</code></p>
        <p class="info"><strong>Node.js:</strong> <code>${process.version}</code></p>
        <hr>
        <p style="font-size: 12px; opacity: 0.8;">
          Deployed by: samba-diallo | Tutorial: GCP Compute Engine Deployment
        </p>
      </div>
    </body>
    </html>
  `);
});

const port = process.env.PORT || 80;
server.listen(port, () => {
  console.log(`Server running on port ${port}`);
  console.log(`Hostname: ${os.hostname()}`);
});
EOF

# Install PM2 for process management
echo "Installing PM2..."
npm install -g pm2

# Start application with PM2
echo "Starting application with PM2..."
pm2 start /opt/sample-app/app.js --name sample-app

# Configure PM2 to start on boot
echo "Configuring PM2 startup..."
pm2 startup systemd -u root --hp /root
pm2 save

echo "=========================================="
echo "Startup Script Completed Successfully!"
echo "Time: $(date)"
echo "=========================================="
```

---

### √âtape 2.3 : Explication D√©taill√©e du Script

#### Partie 1 : Initialisation et Logging

```bash
#!/bin/bash
set -e

# Log everything
exec > >(tee /var/log/startup-script.log)
exec 2>&1

echo "Starting Startup Script"
echo "Time: $(date)"
```

**Explication :**

| Ligne | Signification |
|-------|---------------|
| `#!/bin/bash` | Ex√©cute avec Bash |
| `set -e` | Arr√™te si erreur |
| `exec > >(tee ...)` | Redirige sortie vers fichier + √©cran |
| `exec 2>&1` | Redirige erreurs vers sortie standard |

**R√©sultat :**

```
‚úÖ Tous les logs sauvegard√©s dans /var/log/startup-script.log
‚úÖ Visible dans console GCP (Cloud Logging)
‚úÖ Facilite le d√©bogage
```

---

#### Partie 2 : Mise √† Jour Syst√®me

```bash
echo "Updating system packages..."
apt-get update
apt-get upgrade -y
```

**Pourquoi ?**

```
S√©curit√© :
‚Üí Patches de s√©curit√© r√©cents
‚Üí Corrections de bugs
‚Üí Derni√®res versions des packages

Bonnes pratiques :
‚úÖ Toujours mettre √† jour avant install
‚úÖ √âvite les conflits de d√©pendances
```

---

#### Partie 3 : Installation Node.js

```bash
echo "Installing Node.js..."
curl -fsSL https://deb.nodesource.com/setup_21.x | bash -
apt-get install -y nodejs

echo "Node.js version: $(node --version)"
echo "npm version: $(npm --version)"
```

**Diff√©rence avec AWS :**

| Aspect | AWS (Amazon Linux) | GCP (Ubuntu) |
|--------|-------------------|--------------|
| Gestionnaire | `yum` | `apt-get` |
| Repo Node.js | `rpm.nodesource.com` | `deb.nodesource.com` |
| Format packages | `.rpm` | `.deb` |

---

#### Partie 4 : Cr√©ation de l'Application

```bash
mkdir -p /opt/sample-app
cd /opt/sample-app

cat > /opt/sample-app/app.js << 'EOF'
const http = require('http');
const os = require('os');

const server = http.createServer((req, res) => {
  const hostname = os.hostname();
  const platform = os.platform();
  const uptime = process.uptime();
  
  res.writeHead(200, { 'Content-Type': 'text/html' });
  res.end(`
    <!DOCTYPE html>
    <html>
    ...
  `);
});

const port = process.env.PORT || 80;
server.listen(port, () => {
  console.log(`Server running on port ${port}`);
});
EOF
```

**Am√©liorations par rapport √† AWS :**

```
‚úÖ HTML format√© (plus joli qu'un simple texte)
‚úÖ Affiche des infos syst√®me (hostname, uptime)
‚úÖ CSS int√©gr√© (gradient background)
‚úÖ Plus professionnel

Modules utilis√©s :
‚Üí http : Serveur HTTP
‚Üí os : Informations syst√®me
```

---

#### Partie 5 : PM2 Process Manager üöÄ NOUVEAU !

```bash
npm install -g pm2

pm2 start /opt/sample-app/app.js --name sample-app

pm2 startup systemd -u root --hp /root
pm2 save
```

**Qu'est-ce que PM2 ?**

```
PM2 = Production Process Manager for Node.js

Avantages :
‚úÖ Red√©marre l'app si crash
‚úÖ D√©marre automatiquement au boot
‚úÖ Load balancing (plusieurs instances)
‚úÖ Logs centralis√©s
‚úÖ Monitoring int√©gr√©
‚úÖ Zero-downtime reload

Diff√©rence avec AWS :
AWS User Data ‚Üí "nohup node app.js &" (basique)
GCP Startup Script ‚Üí PM2 (production-ready)
```

**Commandes PM2 :**

| Commande | Action |
|----------|--------|
| `pm2 start app.js` | D√©marre l'app |
| `pm2 stop app` | Arr√™te l'app |
| `pm2 restart app` | Red√©marre l'app |
| `pm2 logs` | Voir les logs |
| `pm2 list` | Lister les apps |
| `pm2 monit` | Monitoring temps r√©el |
| `pm2 save` | Sauvegarder la config |

---

### √âtape 2.4 : Lancement de l'Instance

**Actions Finales :**

```
1. ‚úÖ V√©rifier tous les param√®tres :
   - Name : sample-app-vm
   - Region : us-central1
   - Machine type : e2-micro
   - Boot disk : Ubuntu 22.04 LTS
   - Firewall : HTTP autoris√©
   - Startup script : Coll√©

2. ‚úÖ Faire d√©filer en bas de la page

3. üöÄ Cliquer sur "CREATE" (bouton bleu)
```

---

**Timeline de Cr√©ation :**

```
00:00 - Clic sur CREATE
00:05 - GCP alloue les ressources
00:10 - VM d√©marre (boot Ubuntu)
00:20 - √âtat : RUNNING ‚úÖ
00:30 - Startup Script commence
01:00 - Installation Node.js
01:30 - Installation PM2
02:00 - Application d√©marr√©e
02:30 - Pr√™t √† tester ! ‚úÖ
```

**Temps total : ~2-3 minutes**

---

**Page de R√©sultat :**

```
‚úÖ Message : "Instance created"
```

**Informations Visibles :**

| Information | Exemple | Utilit√© |
|-------------|---------|---------|
| **Name** | sample-app-vm | Identifiant |
| **Zone** | us-central1-a | Localisation |
| **Internal IP** | 10.128.0.2 | R√©seau interne GCP |
| **External IP** | 34.122.45.67 | Acc√®s Internet |
| **Status** | RUNNING | √âtat |

---

## üíª Partie 3 : Comprendre le Code

### Architecture de l'Application sur GCP

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Internet (Clients)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ HTTP Request
             ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  GCP VPC Firewall Rules            ‚îÇ
‚îÇ  default-allow-http (tag: http)    ‚îÇ
‚îÇ  Ports: 80                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ Traffic autoris√©
             ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Compute Engine VM                 ‚îÇ
‚îÇ  Region: us-central1               ‚îÇ
‚îÇ  Zone: us-central1-a               ‚îÇ
‚îÇ                                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Ubuntu 22.04 LTS            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  Node.js 21.x          ‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  PM2 Manager     ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  app.js    ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  Port 80   ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                    ‚îÇ
‚îÇ  Logs ‚Üí Cloud Logging              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ HTTP Response
             ‚îÇ HTML + CSS
             ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Navigateur (Client)              ‚îÇ
‚îÇ   Affiche page stylis√©e            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### Code Node.js Expliqu√©

#### Import des Modules

```javascript
const http = require('http');
const os = require('os');
```

**Module `os` (Operating System) :**

```javascript
os.hostname()  // Nom de la machine (ex: sample-app-vm)
os.platform()  // Syst√®me d'exploitation (ex: linux)
os.uptime()    // Temps depuis d√©marrage OS
os.cpus()      // Informations CPUs
os.totalmem()  // RAM totale
os.freemem()   // RAM disponible
```

---

#### Cr√©ation du Serveur avec Infos Syst√®me

```javascript
const server = http.createServer((req, res) => {
  const hostname = os.hostname();
  const platform = os.platform();
  const uptime = process.uptime();
  
  res.writeHead(200, { 'Content-Type': 'text/html' });
  res.end(`...HTML...`);
});
```

**Diff√©rences avec version AWS :**

| Aspect | AWS Version | GCP Version |
|--------|-------------|-------------|
| Content-Type | `text/plain` | `text/html` |
| Corps | `Hello, World!\n` | Page HTML compl√®te |
| Infos | Aucune | Hostname, Platform, Uptime |
| Styling | Non | CSS avec gradient |
| Professionalisme | Basique | Production-ready |

---

#### Template Literals Avanc√©s

```javascript
res.end(`
  <!DOCTYPE html>
  <html>
  <head>
    <title>Hello from GCP!</title>
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
    </style>
  </head>
  <body>
    <h1>Hello from Google Cloud Platform!</h1>
    <p>Hostname: <code>${hostname}</code></p>
    <p>Uptime: <code>${uptime.toFixed(2)}s</code></p>
  </body>
  </html>
`);
```

**Fonctionnalit√©s :**

```
Template Literals :
‚Üí Backticks `...` (pas quotes '...')
‚Üí Multiligne sans concat√©nation
‚Üí Interpolation ${variable}
‚Üí Expressions ${expr.method()}

CSS Inline :
‚Üí Linear gradient background
‚Üí Responsive (max-width)
‚Üí Glass morphism effect (backdrop-filter)
‚Üí Professional look
```

---

### Gestion de Processus avec PM2

#### Pourquoi PM2 est Crucial

**Sans PM2 (approche AWS basique) :**

```
Probl√®mes :
‚ùå App crash ‚Üí Downtime complet
‚ùå Red√©marrage VM ‚Üí App ne red√©marre pas
‚ùå Pas de logs persistants
‚ùå Pas de monitoring
‚ùå Pas de load balancing

Exemple de crash :
‚Üí Exception non g√©r√©e
‚Üí M√©moire insuffisante
‚Üí Bug dans le code
‚Üí App s'arr√™te ‚Üí Site down ‚ùå
```

**Avec PM2 (approche GCP de ce tuto) :**

```
Avantages :
‚úÖ Crash ‚Üí Red√©marrage automatique (0.1s)
‚úÖ Red√©marrage VM ‚Üí App red√©marre auto
‚úÖ Logs sauvegard√©s dans /root/.pm2/logs/
‚úÖ Monitoring : pm2 monit
‚úÖ Cluster mode : pm2 start -i max (multi-CPU)

Exemple de crash :
‚Üí Exception non g√©r√©e
‚Üí PM2 d√©tecte le crash
‚Üí Red√©marre l'app en 100ms
‚Üí Site reste up ‚úÖ
```

---

#### Cycle de Vie d'une App avec PM2

```
1. D√©marrage
   pm2 start app.js
   ‚Üì
2. App Running
   PM2 surveille le processus
   ‚Üì
3. Crash d√©tect√©
   App s'est arr√™t√©e
   ‚Üì
4. Red√©marrage Auto
   PM2 relance l'app (< 1s)
   ‚Üì
5. Back to Running
   App disponible √† nouveau

VM Reboot :
1. Systemd d√©marre
2. Systemd lance PM2
3. PM2 lit la config sauvegard√©e
4. PM2 relance toutes les apps
5. Apps disponibles ‚úÖ
```

---

#### Commandes PM2 Utiles

**Gestion de Base :**

```bash
# Lister les applications
pm2 list

# Voir les logs en temps r√©el
pm2 logs

# Logs d'une app sp√©cifique
pm2 logs sample-app

# Monitoring en temps r√©el
pm2 monit

# Red√©marrer une app
pm2 restart sample-app

# Arr√™ter une app
pm2 stop sample-app

# Supprimer une app de PM2
pm2 delete sample-app
```

**Cluster Mode (Load Balancing) :**

```bash
# D√©marrer en mode cluster (autant d'instances que de CPUs)
pm2 start app.js -i max

# Ou nombre sp√©cifique
pm2 start app.js -i 4

# Recharger sans downtime
pm2 reload sample-app
```

**Configuration Avanc√©e :**

```bash
# Cr√©er fichier ecosystem.config.js
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'sample-app',
    script: '/opt/sample-app/app.js',
    instances: 2,
    exec_mode: 'cluster',
    watch: true,
    max_memory_restart: '300M',
    env: {
      NODE_ENV: 'production',
      PORT: 80
    }
  }]
};
EOF

# D√©marrer avec config
pm2 start ecosystem.config.js
```

---

### Comparaison : Startup Script vs User Data

| Aspect | GCP Startup Script | AWS User Data |
|--------|-------------------|---------------|
| **Ex√©cution** | √Ä chaque boot | Premier boot uniquement |
| **Stockage** | Instance metadata | Instance metadata |
| **Modification** | Possible sans recr√©er VM | N√©cessite recr√©er instance |
| **Logs** | Cloud Logging auto | N√©cessite config |
| **Taille max** | 256 KB | 16 KB |
| **Format** | Bash, Python, etc. | Bash, PowerShell |

---

## ‚úÖ Partie 4 : Test & V√©rification

### √âtape 4.1 : Observer le D√©marrage

#### Page VM Instances

```
Compute Engine ‚Üí VM instances
```

**Vous devriez voir :**

| Colonne | Valeur | Signification |
|---------|--------|---------------|
| **Name** | sample-app-vm | Votre VM |
| **Zone** | us-central1-a | Localisation |
| **Internal IP** | 10.128.0.2 | IP priv√©e GCP |
| **External IP** | 34.122.45.67 | IP publique Internet |
| **Connect** | SSH | Bouton de connexion |

---

#### √âtats de la VM

```
Progression :
‚è≥ PROVISIONING ‚Üí Allocation des ressources
‚è≥ STAGING ‚Üí Pr√©paration
üü¢ RUNNING ‚Üí VM active ‚úÖ

Autres √©tats possibles :
üî¥ STOPPING ‚Üí En arr√™t
‚èπÔ∏è TERMINATED ‚Üí Arr√™t√©e
üîÑ SUSPENDING ‚Üí Suspension en cours
```

---

### √âtape 4.2 : R√©cup√©rer l'IP Publique

**Option 1 : Via l'Interface**

```
VM instances ‚Üí Colonne "External IP"
Exemple : 34.122.45.67
```

**Option 2 : Via Cloud Shell**

```bash
# Ouvrir Cloud Shell (ic√¥ne >_ en haut)

# Lister les instances
gcloud compute instances list

# Obtenir l'IP externe
gcloud compute instances describe sample-app-vm \
  --zone=us-central1-a \
  --format='get(networkInterfaces[0].accessConfigs[0].natIP)'
```

---

### √âtape 4.3 : V√©rifier les Logs de D√©marrage

**Via l'Interface :**

```
1. VM instances
2. Cliquer sur "sample-app-vm"
3. Onglet "Logs" (ou "OBSERVABILITY" ‚Üí "Logs")
4. Chercher : "startup-script"
```

**Vous devriez voir :**

```
Starting Startup Script
Updating system packages...
Installing Node.js...
Node.js version: v21.x.x
Installing PM2...
Starting application with PM2...
Startup Script Completed Successfully!
```

---

**Via Cloud Shell (SSH) :**

```bash
# Se connecter √† la VM
gcloud compute ssh sample-app-vm --zone=us-central1-a

# Voir les logs du startup script
sudo cat /var/log/startup-script.log

# V√©rifier le statut PM2
sudo pm2 list

# Voir les logs de l'app
sudo pm2 logs sample-app

# Quitter SSH
exit
```

---

### √âtape 4.4 : Tester l'Application

#### Dans votre Navigateur

```
1. Copier l'IP externe : 34.122.45.67
2. Ouvrir navigateur
3. Taper : http://34.122.45.67
   
‚ö†Ô∏è Important : http:// (pas https://)

4. Appuyer sur Entr√©e
```

---

#### üéâ R√©sultat Attendu

**Vous devriez voir une page stylis√©e avec :**

```
üéâ Hello from Google Cloud Platform!

‚úÖ Your Node.js app is running successfully on GCP Compute Engine

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

Hostname: sample-app-vm
Platform: linux
App Uptime: 123.45s
Node.js: v21.x.x

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

Deployed by: samba-diallo | Tutorial: GCP Compute Engine Deployment
```

**Design :**

```
‚úÖ Fond avec gradient violet/bleu
‚úÖ Conteneur avec effet glass morphism
‚úÖ Informations syst√®me dynamiques
‚úÖ Aspect professionnel
```

---

**F√âLICITATIONS !** üéä

```
‚úÖ Application d√©ploy√©e sur GCP !
‚úÖ VM accessible sur Internet
‚úÖ PM2 g√®re votre app
‚úÖ Logs centralis√©s
‚úÖ Production-ready setup !
```

---

### √âtape 4.5 : Tests Avanc√©s

#### Test 1 : Rafra√Æchissement Multiple

```
Action :
‚Üí Appuyer sur F5 plusieurs fois dans le navigateur

Observation :
‚Üí "App Uptime" augmente √† chaque refresh
‚Üí Hostname reste le m√™me
‚Üí R√©ponse rapide (< 100ms)

Conclusion :
‚úÖ App stable
‚úÖ PM2 maintient le processus
‚úÖ Pas de restart intempestif
```

---

#### Test 2 : V√©rifier PM2 Status

```bash
# SSH dans la VM
gcloud compute ssh sample-app-vm --zone=us-central1-a

# Statut PM2
sudo pm2 status

# R√©sultat attendu :
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ id  ‚îÇ name         ‚îÇ mode        ‚îÇ ‚Ü∫       ‚îÇ status  ‚îÇ cpu      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 0   ‚îÇ sample-app   ‚îÇ fork        ‚îÇ 0       ‚îÇ online  ‚îÇ 0%       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

# Monitoring temps r√©el
sudo pm2 monit

# Quitter : Ctrl+C puis exit
```

---

#### Test 3 : V√©rifier les R√®gles de Firewall

**Via Interface :**

```
1. Navigation Menu (‚ò∞)
2. VPC network ‚Üí Firewall
3. Chercher : "default-allow-http"
4. V√©rifier :
```

| Param√®tre | Valeur |
|-----------|--------|
| **Targets** | Specified target tags: http-server |
| **Source filter** | IP ranges: 0.0.0.0/0 |
| **Protocols / ports** | tcp:80 |
| **Action on match** | Allow |

**Via Cloud Shell :**

```bash
gcloud compute firewall-rules list --filter="name:default-allow-http"
```

---

## üèãÔ∏è Exercices Pratiques

### Exercice 1 : Test de Crash Recovery

#### Objectif

D√©montrer la r√©silience de PM2 en cas de crash applicatif.

---

#### Actions

**1. Se Connecter √† la VM**

```bash
gcloud compute ssh sample-app-vm --zone=us-central1-a
```

**2. Modifier l'App pour Crasher**

```bash
# Cr√©er une version qui crash
sudo cat > /opt/sample-app/crash-app.js << 'EOF'
const http = require('http');

const server = http.createServer((req, res) => {
  if (req.url === '/crash') {
    // Crash intentionnel
    throw new Error('Intentional crash!');
  }
  
  res.writeHead(200, { 'Content-Type': 'text/plain' });
  res.end('Hello! Visit /crash to crash the app\n');
});

server.listen(80, () => {
  console.log('Crash test server running on port 80');
});
EOF

# Remplacer l'app par la version crash
sudo pm2 stop sample-app
sudo pm2 delete sample-app
sudo pm2 start /opt/sample-app/crash-app.js --name sample-app
sudo pm2 save
```

**3. Tester le Crash**

```bash
# Dans la VM
curl http://localhost/crash

# Ou dans votre navigateur
http://VOTRE_IP/crash
```

**4. Observer le Comportement**

```bash
# Voir les logs PM2
sudo pm2 logs

# Vous devriez voir :
# Error: Intentional crash!
# PM2: App [sample-app] will restart in 100ms

# Statut PM2
sudo pm2 status

# Colonne "‚Ü∫" (restarts) devrait augmenter
```

---

#### R√©sultat Attendu

```
‚úÖ App crash d√©tect√© par PM2
‚úÖ Red√©marrage automatique en ~100ms
‚úÖ App disponible √† nouveau
‚úÖ Compteur de restarts incr√©ment√©

Comparaison avec approche basique :
‚ùå Sans PM2 : App down d√©finitivement
‚úÖ Avec PM2 : Downtime < 1 seconde
```

---

**5. Restaurer l'App Originale**

```bash
sudo pm2 stop sample-app
sudo pm2 delete sample-app
sudo pm2 start /opt/sample-app/app.js --name sample-app
sudo pm2 save
exit
```

---

### Exercice 2 : Test de Red√©marrage VM

#### Objectif

V√©rifier que l'application red√©marre automatiquement apr√®s un reboot de la VM.

---

#### Actions

**1. Red√©marrer la VM**

**Via Interface :**

```
VM instances
‚Üí S√©lectionner sample-app-vm (checkbox)
‚Üí Bouton "RESET" (en haut)
‚Üí Confirmer
```

**Via Cloud Shell :**

```bash
gcloud compute instances reset sample-app-vm --zone=us-central1-a
```

**2. Observer l'√âtat**

```
√âtat : RUNNING ‚Üí STOPPING ‚Üí PROVISIONING ‚Üí RUNNING
Temps : ~30-60 secondes
```

**3. Attendre 2 Minutes**

```
Laisser le temps au startup script de s'ex√©cuter
```

**4. Tester l'Application**

```
Navigateur : http://VOTRE_IP
```

---

#### Question

**L'application fonctionne-t-elle apr√®s le reboot ?**

<details>
<summary>üí° Cliquez pour voir la r√©ponse</summary>

### R√©ponse : ‚úÖ OUI !

**Pourquoi ?**

```
Diff√©rence GCP vs AWS :

AWS User Data :
‚ùå Ex√©cution UNE SEULE FOIS (premier boot)
‚Üí Apr√®s reboot : Script ne r√©ex√©cute pas
‚Üí App non red√©marr√©e automatiquement

GCP Startup Script :
‚úÖ Ex√©cution √Ä CHAQUE BOOT
‚Üí Apr√®s reboot : Script s'ex√©cute √† nouveau
‚Üí App red√©marr√©e automatiquement

En plus, avec PM2 :
‚úÖ pm2 startup systemd configur√©
‚úÖ PM2 d√©marre avant l'app
‚úÖ PM2 lit la config sauvegard√©e (pm2 save)
‚úÖ PM2 relance toutes les apps

Double s√©curit√© :
1. Startup Script relance l'app
2. PM2 startup relance aussi l'app
‚Üí R√©silience maximale !
```

---

### V√©rification

**SSH dans la VM :**

```bash
gcloud compute ssh sample-app-vm --zone=us-central1-a

# V√©rifier uptime de la VM
uptime
# Output : up 2 minutes (VM a red√©marr√© r√©cemment)

# V√©rifier PM2
sudo pm2 status
# App devrait √™tre "online"

# V√©rifier logs startup script
sudo cat /var/log/startup-script.log | tail -20
# Devrait montrer "Startup Script Completed Successfully!"

exit
```

---

### Le√ßon Importante

```
GCP Startup Script > AWS User Data pour la r√©silience :

‚úÖ Avantage GCP :
‚Üí R√©ex√©cution √† chaque boot
‚Üí App toujours red√©marr√©e
‚Üí Moins de configuration manuelle

‚ö†Ô∏è Consid√©ration :
‚Üí Script doit √™tre idempotent (peut s'ex√©cuter plusieurs fois)
‚Üí Attention aux installations multiples
‚Üí Utiliser des checks (if not installed, then install)

Best Practice :
‚Üí GCP : Startup Script + PM2
‚Üí AWS : User Data + Systemd Service
‚Üí Les deux : Container orchestration (Kubernetes)
```

</details>

---

### Exercice 3 : Explorer Cloud Logging

#### Objectif

Comprendre les outils de monitoring GCP et comparer avec CloudWatch (AWS).

---

#### Actions

**1. Acc√©der √† Cloud Logging**

```
Navigation Menu (‚ò∞)
‚Üí Logging (ou "Operations" ‚Üí "Logging")
‚Üí Logs Explorer
```

**2. Filtrer les Logs de la VM**

```
Dans la barre de recherche :

resource.type="gce_instance"
resource.labels.instance_id="VOTRE_INSTANCE_ID"

OU simplement :

logName="projects/VOTRE_PROJECT/logs/syslog"
```

**3. Voir les Logs du Startup Script**

```
Filtre :

jsonPayload.message=~"startup-script"

OU

textPayload=~"Installing Node.js"
```

**4. Cr√©er une Metric Bas√©e sur les Logs**

```
1. Dans Logs Explorer, cliquer "Actions" ‚Üí "Create metric"
2. Configuration :
   - Metric Type : Counter
   - Filter : textPayload=~"Startup Script Completed"
   - Name : startup_script_success
3. CREATE METRIC
```

---

#### Cloud Monitoring (Anciennement Stackdriver)

**Acc√©der aux M√©triques :**

```
Navigation Menu (‚ò∞)
‚Üí Monitoring (ou "Operations" ‚Üí "Monitoring")
‚Üí Metrics Explorer
```

**M√©triques Disponibles :**

| M√©trique | Cat√©gorie | Description |
|----------|-----------|-------------|
| **CPU utilization** | VM Instance | % utilisation CPU |
| **Disk read bytes** | VM Instance | Lecture disque (bytes/s) |
| **Network bytes sent** | VM Instance | Trafic r√©seau sortant |
| **Memory usage** | Agent requis | RAM utilis√©e |

**Visualiser CPU :**

```
1. Resource type : VM Instance
2. Metric : compute.googleapis.com/instance/cpu/utilization
3. Filter : instance_name = sample-app-vm
4. Aggregator : mean
5. Group by : instance_name
6. Time range : 1 hour
```

---

#### Cr√©er un Dashboard

```
1. Monitoring ‚Üí Dashboards ‚Üí CREATE DASHBOARD
2. Name : "Sample App Monitoring"
3. ADD CHART
4. Configuration :
   - Title : CPU Utilization
   - Resource : VM Instance
   - Metric : CPU utilization
   - Filter : sample-app-vm
5. SAVE
6. Ajouter d'autres charts (Network, Disk, etc.)
```

---

#### Configurer une Alerte

```
1. Monitoring ‚Üí Alerting ‚Üí CREATE POLICY
2. Configuration :
```

| Param√®tre | Valeur |
|-----------|--------|
| **Target** | VM Instance ‚Üí CPU utilization |
| **Filter** | instance_name = sample-app-vm |
| **Condition** | CPU > 80% for 5 minutes |
| **Notification** | Email : votre-email@gmail.com |

```
3. SAVE
```

---

#### Comparaison GCP vs AWS

<details>
<summary>üí° Cliquez pour voir la comparaison</summary>

| Aspect | GCP Cloud Logging/Monitoring | AWS CloudWatch |
|--------|------------------------------|----------------|
| **Logs** | Gratuit (50 GB/mois) | Payant (5 GB gratuit) |
| **Retention** | 30 jours (configurable) | Configurable (co√ªt) |
| **M√©triques** | Gratuit (up to 150 MB/mois) | 10 m√©triques gratuit |
| **Interface** | Logs Explorer (moderne) | CloudWatch Insights (complexe) |
| **Recherche** | BigQuery integration | CloudWatch Logs Insights |
| **Alertes** | Gratuites | 10 alarmes gratuites |
| **Dashboards** | Illimit√© gratuit | 3 dashboards gratuits |
| **Agent** | Optional (memory metrics) | Optional (detailed metrics) |

---

### Forces de GCP

```
‚úÖ Logs gratuits (50 GB/mois vs 5 GB AWS)
‚úÖ Interface plus moderne et intuitive
‚úÖ BigQuery pour analyse avanc√©e
‚úÖ Dashboards illimit√©s gratuits
‚úÖ Trace et Debugger int√©gr√©s

Exemple Pricing :
‚Üí GCP : 50 GB logs/mois = GRATUIT
‚Üí AWS : 50 GB logs/mois = ~$25/mois
```

---

### Forces d'AWS

```
‚úÖ Plus mature (lanc√© 2009 vs 2014)
‚úÖ Plus de m√©triques pr√™tes √† l'emploi
‚úÖ Int√©gration avec tous services AWS
‚úÖ CloudWatch Contributor Insights
‚úÖ Anomaly Detection natif

Exemple :
‚Üí AWS : Lambda logs automatiques
‚Üí GCP : Cloud Functions logs automatiques
‚Üí √âquivalent mais AWS plus de services
```

---

### Utilisation Multi-Cloud

```
Strat√©gie :
‚Üí GCP : Analytics (BigQuery), ML, Logs
‚Üí AWS : Compute (EC2), Storage (S3), CDN
‚Üí Logs envoy√©s vers Datadog/Splunk
‚Üí M√©triques agr√©g√©es dans Grafana

Outils Tiers :
‚Üí Datadog (monitoring multi-cloud)
‚Üí New Relic (APM)
‚Üí Grafana + Prometheus
‚Üí ELK Stack (Elasticsearch, Logstash, Kibana)
```

</details>

---

## üîß D√©pannage

### Probl√®me 1 : Connection Timeout

#### Sympt√¥me

```
Erreur navigateur :
"Ce site est inaccessible"
"ERR_CONNECTION_TIMED_OUT"
```

---

#### Causes et Solutions

**Cause 1 : R√®gle de Firewall Absente** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê

**V√©rifier :**

```bash
gcloud compute firewall-rules list --filter="targetTags:http-server"
```

**Si vide ou pas de r√®gle pour port 80 :**

```bash
# Cr√©er la r√®gle de firewall
gcloud compute firewall-rules create allow-http \
  --allow=tcp:80 \
  --source-ranges=0.0.0.0/0 \
  --target-tags=http-server \
  --description="Allow HTTP traffic"

# Ajouter le tag √† la VM
gcloud compute instances add-tags sample-app-vm \
  --zone=us-central1-a \
  --tags=http-server
```

---

**Cause 2 : VM pas encore Pr√™te** ‚≠ê‚≠ê‚≠ê

```
Solution :
‚Üí Attendre 3-4 minutes apr√®s cr√©ation
‚Üí V√©rifier status : gcloud compute instances list
‚Üí Doit √™tre RUNNING
```

---

**Cause 3 : Startup Script a √âchou√©** ‚≠ê‚≠ê

**V√©rifier les logs :**

```bash
# SSH dans la VM
gcloud compute ssh sample-app-vm --zone=us-central1-a

# Voir logs startup
sudo cat /var/log/startup-script.log

# Chercher erreurs
sudo cat /var/log/startup-script.log | grep -i error

# V√©rifier PM2
sudo pm2 status

# Si app pas list√©e ‚Üí Startup script a √©chou√©
# Relancer manuellement :
cd /opt/sample-app
sudo pm2 start app.js --name sample-app
sudo pm2 save

exit
```

---

**Cause 4 : Port 80 d√©j√†
